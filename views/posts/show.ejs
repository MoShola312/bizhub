<% layout('layouts/post-show-layout') -%>
<div class="row">
	<div class="col-lg-12 ">
		<% post.images.forEach(function(image) { %>
			<img src="<%= image.url %>" alt="Surf board image" width="200px">
		<% }); %>
	</div>
</div>
<hr>

<div class="container-fluid">
	<div class="row">
		<div class="col-2"></div>
		<div class="col-6">
			<h1><%= post.title %></h1>
			<!-- displays ratings in stars icons -->
			<% function starDisplay(rating, avgRating) { %>
				<% for(let i = 0; i < 5; i++) { %>
					<% if(i < rating) { %>
						<!-- display a full star -->
						<i class="fas fa-star"></i>
					<% } else if((avgRating - i) > 0 && (avgRating - i) < 1) { %>
							<!-- display a half star -->
							<i class="fas fa-star-half-alt"></i>
							<% } else { %>
								<!-- display an empty star -->
								<i class="far fa-star"></i>
							<% } %>
				<% } %>
			<% } %>
			<% starDisplay(floorRating, post.avgRating) %>
			<%= `${post.avgRating} star${post.avgRating === 1 ? '' : 's'}` %>
			<hr>
			<% if (post.location) { %>
				<div class="col-6 ">
					<div id='map'></div>
				</div>
			<% } %>
			<hr>
		</div>
		<div class="col-3 list-group">
			<% if(post.owner.isAdmin){ %>
				<li class="list-group-item"><strong>This business hasn't been claimed yet.</strong></li>
			  <% } else { %>
				<li class="list-group-item">Owner: <%= post.owner.username %></li>
			<% } %>
				
			
			<li class="list-group-item">Description: <%= post.description %></li>
			<% if (post.isSocial==='yes'){%>
				
				<li class="list-group-item">Price: <%= post.price %></li>
				<li class="list-group-item">Music: <%= post.music.join(', ') %></li>
				<li class="list-group-item">Crowd: <%= post.crowd.join(', ') %></li>
			<% } %>
			<li class="list-group-item">Phone: <%= post.phone %></li>
			<li class="list-group-item">Website: <a href="<%= post.website %>" target="_blank"> <%= post.website %></a></li>
			<% if (post.onlineOnly==='no'){%>
				<li class="list-group-item">Location: <%= post.location %></li>
				<li class="list-group-item">Hours:<br>
				<% post.hours.forEach(function(hour){ %>
					<% let opening; %>
					<% let closing; %>
					<span class='day'><%= day= hour.slice(0,3) %></span> 
					<% if(hour.includes('Closed')){ %>
						<span > <%= opening=hour.slice(3) %></span>
						<span> <%= closing=hour.slice(-1)%></span>
					<%}  else if (hour.includes('midnight')) { %>
						<span> <%= opening=hour.slice(3,(hour.indexOf("t")+2)) %> - </span>
						<span> <%= closing=hour.slice(hour.indexOf("t") + 2); %></span>
					<% } else  { %>
					<span> <%= opening=hour.slice(3,(hour.indexOf("m")+1)) %> - </span>
					<span> <%= closing=hour.slice(hour.indexOf("m") + 1); %></span>
					<% } %>
					<br>   
				<% }) %>
			</li>
			<%}%>
			<li class="list-group-item">Categories: <%= post.categories.join(', ') %></li>
		</div>
	</div>
	
<div class="row">
	<div class="col-2"></div>
	<!-- <% if (post.location) { %>
	<div class="col-6">
		<div id='map'></div>
	</div>
     <% } %> -->
	<div class="col-2">
		
		<% if (currentUser && post.owner.equals(currentUser._id) || currentUser && currentUser.isAdmin) { %>
			<div class="form-group">
				<a href="/posts/<%= post.id %>/edit" class="form-group">
					<button class="btn btn-primary mb-2">Edit</button>
				</a>
			</div>
			<% } %>
			
			<% if (currentUser && currentUser.isAdmin) { %>
			<div class="form-group">
				<form class="delete-form" action="/posts/<%= post.id %>?_method=DELETE" method="POST">
					<input class="btn btn-danger" type="submit" value="Delete">
				</form>
			</div>
		<% } %>
	</div>
</div>		

<!-- Create a review -->
<div class="row">
	<div class="col-2"></div>
	<div class="col-6">
		<% if(currentUser) { %>
			<h2>Create a Review</h2>
			<form action="/posts/<%= post.id %>/reviews" method="POST" id='create-review-form'>
				<textarea name="review[body]" required></textarea>
				<fieldset class="starability-basic">
					<legend>Rating:</legend>
					<button class="clear-rating btn btn-warning mb-2" type="button">Clear Rating</button>
					<input type="radio" id="rate0" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
					<input type="radio" id="rate1" name="review[rating]" value="1" />
					<label for="rate1" title="Terrible">1 star</label>
					<input type="radio" id="rate2" name="review[rating]" value="2" />
					<label for="rate2" title="Not good">2 stars</label>
					<input type="radio" id="rate3" name="review[rating]" value="3" />
					<label for="rate3" title="Average">3 stars</label>
					<input type="radio" id="rate4" name="review[rating]" value="4" />
					<label for="rate4" title="Very good">4 stars</label>
					<input type="radio" id="rate5" name="review[rating]" value="5" />
					<label for="rate5" title="Amazing">5 stars</label>
				</fieldset>
			
				<input class="btn btn-success mb-2" type="submit">
			</form>
			<% } else { %>
			<h2><a href="/login?returnTo=true">Create a Review</a></h2>
			<% } %>
	<hr>
	</div>
	<div class="col-2"></div>
</div>


<div class="row">
	<div class="col-2"></div>
	<div class="col-8">
			<h3>Reviews</h3><hr>
	</div>
	<div class="col-2"></div>	
</div>



<!-- display all reviews -->
<% post.reviews.forEach(function(review) { %>
<div class="row">
	<div class="col-2"></div>
	<!-- <p id="append-review"></p> -->
	<div class="col-1">
		<a href="/profile/<%=review.author.id %>"><img src="<%= review.author.image.secure_url %>" class="profile-show-image mr-2">
			<%= review.author.username %></a>
	</div>
	<div class="col-4">
		<p>
			<% starDisplay(review.rating) %> ,  <%= moment(review.createdAt).fromNow() %>
		</p>
		<p>Rating: <%= review.rating %> 
		<br><%= review.body %></p>
		<!-- like button -->
		<div style="padding-bottom: 10px;">
			<form action="/posts/<%= post.id %>/reviews/<%= review.id %>/like" method="POST" class="likeForm">
				<div class="btn-group" id="likesDiv">
					<!-- <% if (currentUser && review.likes.some(function (like) { 
						return like.equals(currentUser._id)
					 })) { %>
						<button class="btn btn-sm btn-primary likedBtn1" id='<%= review.id %>'>
							<i class="fas fa-thumbs-up" ></i> Liked (<%= review.likes.length %>)
						</button>
					<% } else { %> -->
						<button class="btn btn-secondary btn-sm likedBtn1" id='<%= review.id %>'>
							<i class="fas fa-thumbs-up" ></i> Like (<%= review.likes.length %>)
						</button>
					<!-- <% } %> -->

				</div>
			</form>
		</div>


		<div>
			<!-- reply form -->
			<!-- only reviewer and biz owner can reply -->
			<% if(currentUser && post.owner.equals(currentUser._id) || currentUser && currentUser.equals(review.author._id) || currentUser && currentUser.isAdmin) { %>
				<p class="toggle-reply-form">REPLY</p>
				<form action="/posts/<%= post.id %>/reviews/<%= review.id %>/replies" method="POST" class="reply-form">
					<textarea name="reply[body]" required></textarea>
					<input class="btn btn-success mb-2" type="submit">
				</form>
				<!-- hide the reply button if there is a currentUser but is not the owner or the review author -->
				<% } else if (currentUser && !post.owner.equals(currentUser._id) || currentUser && !currentUser.equals(review.author._id))  { %>
					<p> </p>
				<% } else { %>
				<p><a href="/login?returnTo=true" class="toggle-reply-form" >REPLY</a></p>
				<% } %>
		</div>
	</div>
	<!-- update a review -->
	<% if(currentUser && review.author.equals(currentUser._id) || currentUser && currentUser.isAdmin) { %>
		<div class="form-group col-3">
			<button class="toggle-edit-form btn btn-primary mb-2">Edit</button>
			<form action="/posts/<%= post.id %>/reviews/<%= review.id %>?_method=PUT" method="POST" class="edit-review-form">
				<textarea name="review[body]" required><%= review.body %></textarea>
				<fieldset class="starability-basic">
				<legend>Rating:</legend>
				<button class="clear-rating" type="button">Clear Rating</button>
				<input type="radio" id="edit-rate0" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
				<input type="radio" id="edit-rate1" name="review[rating]" value="1" />
				<label for="edit-rate1" title="Terrible">1 star</label>
				<input type="radio" id="edit-rate2" name="review[rating]" value="2" />
				<label for="edit-rate2" title="Not good">2 stars</label>
				<input type="radio" id="edit-rate3" name="review[rating]" value="3" />
				<label for="edit-rate3" title="Average">3 stars</label>
				<input type="radio" id="edit-rate4" name="review[rating]" value="4" />
				<label for="edit-rate4" title="Very good">4 stars</label>
				<input type="radio" id="edit-rate5" name="review[rating]" value="5" />
				<label for="edit-rate5" title="Amazing">5 stars</label>
				</fieldset>
				<input class="btn btn-success" type="submit" value="Update">
			</form>
			<script>
				$('#edit-rate<%= review.rating %>').prop('checked', true);
			</script>
			<form action="/posts/<%= post.id %>/reviews/<%= review.id %>?_method=DELETE" method="POST">
				<input class="btn btn-danger" type="submit" value="Delete">
			</form>
		</div>
		<% } %>
		<div class="col-2"></div>
	</div>

	<!-- display replies -->
	<%	reviewReply.forEach(function(key){ %>
		<!-- if post.review id matches the reviewReply id, display the reply -->
		<% if(review.id===key.id){ %>
			
				<%	key.replies.forEach(function(reply){ %>
				<div class="row">
					<div class="col-3"></div>	
					<div class="col-5 reply-body">
						<!-- gives the owner a checkmark and identifies them -->
						<% if(post.owner.equals(reply.author)&&(!post.owner.isAdmin)){ %>
							<p><a href="/profile/<%=reply.author.id %>"><img src="<%= reply.author.image.secure_url %>" class="reply-profile-show-image mr-2"><strong><%= reply.author.username %></strong>
								<i class="far fa-check-circle"></i></a> owner of <strong><%= post.title %></strong>
							<br><span><%= moment(reply.createdAt).fromNow()%> - <%= reply.body %></span> </p>
							<%} else if(reply.author.isAdmin){ %>
								<p><a href="/profile/<%=reply.author.id %>"><img src="<%= reply.author.image.secure_url %>" class="reply-profile-show-image mr-2"><strong><%= reply.author.username %></strong>
									<i class="fas fa-user-check">Admin</i></a>
								<br><span><%= moment(reply.createdAt).fromNow()%> - <%= reply.body %></span> </p>
							<%} else {%>
								<p><a href="/profile/<%=reply.author.id %>"><img src="<%= reply.author.image.secure_url %>" class="reply-profile-show-image mr-2"><strong><%= reply.author.username %></strong></a> 
								<br><span><%= moment(reply.createdAt).fromNow()%> - <%= reply.body %></span> </p>
						<%}%>
					</div>
					<!-- update a reply -->
					<% if(currentUser && reply.author.equals(currentUser._id) || currentUser && currentUser.isAdmin) { %>
						<div class="form-group col-4">
						<button class="toggle-edit-form mb-2">Edit</button>
						<form action="/posts/<%= post.id %>/reviews/<%= review.id %>/replies/<%= reply.id %>?_method=PUT" method="POST" class="edit-review-form">
							<textarea name="reply[body]" required><%= reply.body %></textarea>
							<input type="submit" value="Update">
						</form>
		
						<form action="/posts/<%= post.id %>/reviews/<%= review.id %>/replies/<%= reply.id %>?_method=DELETE" method="POST">
							<input type="submit" value="Delete">
						</form>
						</div>
					<% } %>	
				</div>
				<% }) %>
		<% } %>
	<%}) %>
	<hr>

<% }) %>

</div>

